name: Java CI with Maven

on:
  # –ó–∞–ø—É—Å–∫ –ø—Ä–∏ –ø—É—à–µ –≤ –æ—Å–Ω–æ–≤–Ω—ã–µ –≤–µ—Ç–∫–∏
  push:
    branches: [ main, master ]
  
  # –ó–∞–ø—É—Å–∫ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ pull request
  pull_request:
    branches: [ main, master ]
  
  # –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ –∏–∑ –≤–∫–ª–∞–¥–∫–∏ Actions
  workflow_dispatch:

env:
  # –ò—Å–ø–æ–ª—å–∑—É–µ–º GitHub Secrets –¥–ª—è –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
  KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
  STUDENT_ID: ${{ secrets.STUDENT_ID }}

jobs:
  # 1. –ö–û–ú–ü–ò–õ–Ø–¶–ò–Ø –ò –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï
  compile-and-test:
    runs-on: ubuntu-latest  # GitHub –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –≤–∏—Ä—Ç—É–∞–ª—å–Ω—É—é –º–∞—à–∏–Ω—É —Å Ubuntu
    
    steps:
    # –®–∞–≥ 1: –ü–æ–ª—É—á–∏—Ç—å –∫–æ–¥ –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
    - name: Checkout repository
      uses: actions/checkout@v4
    
    # –®–∞–≥ 2: –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Java 17
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'  # Eclipse Temurin (AdoptOpenJDK)
        cache: 'maven'  # –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ Maven –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
    
    # –®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø—Ä–æ–µ–∫—Ç–∞
    - name: Verify project structure
      run: |
        echo "üìÅ Project structure:"
        find . -name "*.java" -type f | head -10
        echo "POM exists: $(test -f pom.xml && echo '‚úÖ' || echo '‚ùå')"
    
    # –®–∞–≥ 4: –ö–æ–º–ø–∏–ª—è—Ü–∏—è –ø—Ä–æ–µ–∫—Ç–∞
    - name: Compile project
      run: mvn clean compile -q
      env:
        KEYSTORE_PASSWORD: ${{ env.KEYSTORE_PASSWORD }}
        STUDENT_ID: ${{ env.STUDENT_ID }}
    
    # –®–∞–≥ 5: –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π keystore –¥–ª—è CI
    - name: Generate test keystore
      run: |
        mkdir -p src/test/resources/keystore
        # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞
        keytool -genkeypair \
          -alias test-cert \
          -keyalg RSA \
          -keysize 2048 \
          -validity 365 \
          -keystore src/test/resources/keystore/test.p12 \
          -storepass "$KEYSTORE_PASSWORD" \
          -keypass "$KEYSTORE_PASSWORD" \
          -dname "CN=CI Test, OU=Support System, O=University, L=Moscow, C=RU" \
          -storetype PKCS12
        
        echo "‚úÖ Test keystore generated"
        keytool -list -keystore src/test/resources/keystore/test.p12 \
          -storepass "$KEYSTORE_PASSWORD" | grep "test-cert"
    
    # –®–∞–≥ 6: –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã
    - name: Run tests
      run: mvn test -B  # -B –¥–ª—è non-interactive mode
      env:
        KEYSTORE_PASSWORD: ${{ env.KEYSTORE_PASSWORD }}
        STUDENT_ID: ${{ env.STUDENT_ID }}
    
    # –®–∞–≥ 7: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–∞ –æ —Ç–µ—Å—Ç–∞—Ö
    - name: Test report
      if: always()  # –í—ã–ø–æ–ª–Ω—è—Ç—å –≤—Å–µ–≥–¥–∞, –¥–∞–∂–µ –µ—Å–ª–∏ —Ç–µ—Å—Ç—ã —É–ø–∞–ª–∏
      run: |
        echo "üìä TEST SUMMARY" >> $GITHUB_STEP_SUMMARY
        
        if [ -d "target/surefire-reports" ]; then
          TOTAL=0
          PASSED=0
          FAILED=0
          
          for report in target/surefire-reports/*.xml; do
            if [ -f "$report" ]; then
              TESTS=$(grep -o 'tests="[0-9]*"' "$report" | grep -o '[0-9]*' || echo "0")
              ERRORS=$(grep -o 'errors="[0-9]*"' "$report" | grep -o '[0-9]*' || echo "0")
              FAILURES=$(grep -o 'failures="[0-9]*"' "$report" | grep -o '[0-9]*' || echo "0")
              
              TOTAL=$((TOTAL + TESTS))
              FAILED=$((FAILED + ERRORS + FAILURES))
            fi
          done
          
          PASSED=$((TOTAL - FAILED))
          
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Total Tests | $TOTAL |" >> $GITHUB_STEP_SUMMARY
          echo "| ‚úÖ Passed | $PASSED |" >> $GITHUB_STEP_SUMMARY
          echo "| ‚ùå Failed | $FAILED |" >> $GITHUB_STEP_SUMMARY
        else
          echo "No test reports found" >> $GITHUB_STEP_SUMMARY
        fi

  # 2. –£–ü–ê–ö–û–í–ö–ê –ò –°–û–ó–î–ê–ù–ò–ï –ê–†–¢–ï–§–ê–ö–¢–ê
  package-and-release:
    runs-on: ubuntu-latest
    needs: compile-and-test  # –ó–∞–≤–∏—Å–∏—Ç –æ—Ç —É—Å–ø–µ—à–Ω–æ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ç–µ—Å—Ç–æ–≤
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
    
    # –®–∞–≥ 1: –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ä–µ–∞–ª—å–Ω—ã–π keystore –∏–∑ Secrets (–µ—Å–ª–∏ –µ—Å—Ç—å)
    - name: Load production keystore
      run: |
        mkdir -p src/main/resources/keystore
        
        if [ -n "${{ secrets.KEYSTORE_FILE_BASE64 }}" ]; then
          # –î–µ–∫–æ–¥–∏—Ä—É–µ–º Base64 —Å—Ç—Ä–æ–∫—É –∏–∑ —Å–µ–∫—Ä–µ—Ç–∞
          echo "${{ secrets.KEYSTORE_FILE_BASE64 }}" | base64 --decode > src/main/resources/keystore/keystore.p12
          echo "‚úÖ Production keystore loaded from secrets"
        else
          # –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π keystore –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏
          keytool -genkeypair \
            -alias prod-cert \
            -keyalg RSA \
            -keysize 2048 \
            -validity 365 \
            -keystore src/main/resources/keystore/keystore.p12 \
            -storepass "$KEYSTORE_PASSWORD" \
            -keypass "$KEYSTORE_PASSWORD" \
            -dname "CN=Production, OU=Support System, O=University, C=RU" \
            -storetype PKCS12
          echo "‚ö†Ô∏è  Using generated keystore (no KEYSTORE_FILE_BASE64 secret provided)"
        fi
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º
        ls -la src/main/resources/keystore/
    
    # –®–∞–≥ 2: –°–±–æ—Ä–∫–∞ JAR —Ñ–∞–π–ª–∞
    - name: Build package
      run: mvn clean package -DskipTests -B
      env:
        KEYSTORE_PASSWORD: ${{ env.KEYSTORE_PASSWORD }}
    
    # –®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–±—Ä–∞–Ω–Ω–æ–≥–æ JAR
    - name: Validate JAR file
      run: |
        JAR_FILE=$(find target -name "*.jar" -type f | head -1)
        
        if [ -f "$JAR_FILE" ]; then
          echo "‚úÖ JAR file created: $(basename $JAR_FILE)"
          echo "üìè Size: $(du -h "$JAR_FILE" | cut -f1)"
          
          # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ
          echo "üìÅ JAR structure check:"
          jar tf "$JAR_FILE" | grep -E "(BOOT-INF|META-INF|com/example)" | head -5
          
          # –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ —ç—Ç–æ Spring Boot JAR
          if jar tf "$JAR_FILE" | grep -q "BOOT-INF"; then
            echo "‚úÖ Spring Boot executable JAR"
          else
            echo "‚ö†Ô∏è  Not a Spring Boot executable JAR"
          fi
        else
          echo "‚ùå No JAR file found!"
          exit 1
        fi
    
    # –®–∞–≥ 4: –ó–∞–≥—Ä—É–∑–∫–∞ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∞ –≤ GitHub
    - name: Upload JAR artifact
      uses: actions/upload-artifact@v4
      with:
        name: support-system-jar
        path: target/*.jar
        retention-days: 7  # –•—Ä–∞–Ω–∏—Ç—å 7 –¥–Ω–µ–π
    
    # –®–∞–≥ 5: –°–æ–∑–¥–∞–Ω–∏–µ GitHub Release (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –¥–ª—è –≤–µ—Ä—Å–∏–π)
    - name: Create GitHub Release
      if: startsWith(github.ref, 'refs/tags/v')  # –¢–æ–ª—å–∫–æ –¥–ª—è —Ç–µ–≥–æ–≤ —Å –≤–µ—Ä—Å–∏—è–º–∏
      uses: softprops/action-gh-release@v1
      with:
        files: target/*.jar
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    # –®–∞–≥ 6: –ó–∞–≥—Ä—É–∑–∫–∞ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build-artifacts
        path: |
          pom.xml
          src/main/resources/application.properties
        retention-days: 30
