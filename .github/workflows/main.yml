name: Java CI with Maven

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

env:
  KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD || 'TestPass123!' }}
  STUDENT_ID: ${{ secrets.STUDENT_ID || '1–ë–ò–ë23251' }}
  # –î–æ–±–∞–≤–ª—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é —Å –ø—É—Ç–µ–º –∫ –ø—Ä–æ–µ–∫—Ç—É
  PROJECT_DIR: './support-system'

jobs:
  compile-and-test:
    runs-on: ubuntu-latest
    
    steps:
    # –®–∞–≥ 1: –ü–æ–ª—É—á–∏—Ç—å –∫–æ–¥ –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        # –ï—Å–ª–∏ –ø—Ä–æ–µ–∫—Ç –≤ –ø–æ–¥–ø–∞–ø–∫–µ, –Ω—É–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å path
        path: support-system
    
    # –®–∞–≥ 2: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
    - name: Check repository structure
      run: |
        echo "üìÅ Repository structure:"
        ls -la
        echo ""
        echo "üìÅ Project directory (${{ env.PROJECT_DIR }}):"
        if [ -d "${{ env.PROJECT_DIR }}" ]; then
          cd "${{ env.PROJECT_DIR }}"
          ls -la
          echo "‚úÖ Project directory exists"
        else
          echo "‚ùå Project directory not found, checking root..."
          ls -la
          # –ï—Å–ª–∏ –ø—Ä–æ–µ–∫—Ç –≤ –∫–æ—Ä–Ω–µ, –º–µ–Ω—è–µ–º PROJECT_DIR
          if [ -f "pom.xml" ]; then
            echo "‚ÑπÔ∏è  Project is in root directory"
            echo "PROJECT_DIR=." >> $GITHUB_ENV
          fi
        fi
    
    # –®–∞–≥ 3: –ü–µ—Ä–µ–π—Ç–∏ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞
    - name: Change to project directory
      run: |
        echo "Changing to project directory: ${{ env.PROJECT_DIR }}"
        cd "${{ env.PROJECT_DIR }}"
        echo "Current directory: $(pwd)"
        echo "POM exists: $(test -f pom.xml && echo '‚úÖ' || echo '‚ùå')"
    
    # –®–∞–≥ 4: –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Java 17
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: 'maven'
        cache-dependency-path: "${{ env.PROJECT_DIR }}/pom.xml"
    
    # –®–∞–≥ 5: –ö–æ–º–ø–∏–ª—è—Ü–∏—è –ø—Ä–æ–µ–∫—Ç–∞ (–≤–Ω—É—Ç—Ä–∏ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞)
    - name: Compile project
      working-directory: ${{ env.PROJECT_DIR }}
      run: mvn clean compile -q
      env:
        KEYSTORE_PASSWORD: ${{ env.KEYSTORE_PASSWORD }}
        STUDENT_ID: ${{ env.STUDENT_ID }}
    
    # –®–∞–≥ 6: –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π keystore
    - name: Generate test keystore
      working-directory: ${{ env.PROJECT_DIR }}
      run: |
        mkdir -p src/test/resources/keystore
        keytool -genkeypair \
          -alias test-cert \
          -keyalg RSA \
          -keysize 2048 \
          -validity 365 \
          -keystore src/test/resources/keystore/test.p12 \
          -storepass "$KEYSTORE_PASSWORD" \
          -keypass "$KEYSTORE_PASSWORD" \
          -dname "CN=CI Test, OU=Support System, O=University, L=Moscow, C=RU" \
          -storetype PKCS12
        
        echo "‚úÖ Test keystore generated"
    
    # –®–∞–≥ 7: –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã
    - name: Run tests
      working-directory: ${{ env.PROJECT_DIR }}
      run: mvn test -B
      env:
        KEYSTORE_PASSWORD: ${{ env.KEYSTORE_PASSWORD }}
        STUDENT_ID: ${{ env.STUDENT_ID }}
    
    # –®–∞–≥ 8: –û—Ç—á–µ—Ç –æ —Ç–µ—Å—Ç–∞—Ö
    - name: Test report
      working-directory: ${{ env.PROJECT_DIR }}
      if: always()
      run: |
        echo "üìä TEST RESULTS" >> $GITHUB_STEP_SUMMARY
        
        if [ -d "target/surefire-reports" ]; then
          echo "```bash" >> $GITHUB_STEP_SUMMARY
          find target/surefire-reports -name "*.txt" -exec cat {} \; | head -20 >> $GITHUB_STEP_SUMMARY
          echo "```" >> $GITHUB_STEP_SUMMARY
        else
          echo "No test reports found" >> $GITHUB_STEP_SUMMARY
        fi

  package-and-release:
    runs-on: ubuntu-latest
    needs: compile-and-test
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        path: support-system
    
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
    
    # –®–∞–≥ 1: –°–±–æ—Ä–∫–∞ JAR
    - name: Build package
      working-directory: ${{ env.PROJECT_DIR }}
      run: mvn clean package -DskipTests -B
      env:
        KEYSTORE_PASSWORD: ${{ env.KEYSTORE_PASSWORD }}
        STUDENT_ID: ${{ env.STUDENT_ID }}
    
    # –®–∞–≥ 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ JAR
    - name: Validate JAR file
      working-directory: ${{ env.PROJECT_DIR }}
      run: |
        JAR_FILE=$(find target -name "*.jar" -type f | head -1)
        if [ -f "$JAR_FILE" ]; then
          echo "‚úÖ JAR: $(basename $JAR_FILE)"
          echo "üìè Size: $(du -h "$JAR_FILE" | cut -f1)"
          
          # –°–æ–∑–¥–∞–µ–º summary
          echo "## üöÄ Build Artifact" >> $GITHUB_STEP_SUMMARY
          echo "**File:** $(basename $JAR_FILE)" >> $GITHUB_STEP_SUMMARY
          echo "**Size:** $(du -h "$JAR_FILE" | cut -f1)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Download" >> $GITHUB_STEP_SUMMARY
          echo "Check the Artifacts tab to download the JAR file." >> $GITHUB_STEP_SUMMARY
        else
          echo "‚ùå No JAR found"
          exit 1
        fi
    
    # –®–∞–≥ 3: –ó–∞–≥—Ä—É–∑–∫–∞ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∞
    - name: Upload JAR artifact
      uses: actions/upload-artifact@v4
      with:
        name: support-system-jar
        path: ${{ env.PROJECT_DIR }}/target/*.jar
        retention-days: 7
